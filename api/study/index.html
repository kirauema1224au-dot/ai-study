<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Study API フロント</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            midnight: '#0b1021'
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-midnight text-slate-50">
  <div class="mx-auto flex min-h-screen max-w-6xl flex-col px-4 py-10">
    <div class="flex flex-col gap-4 rounded-3xl border border-slate-800/60 bg-slate-900/70 p-6 shadow-2xl backdrop-blur">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-1">
          <p class="text-xs uppercase tracking-[0.22em] text-slate-400">Study</p>
          <h1 class="text-2xl font-semibold">Study API フロント</h1>
          <p class="text-sm text-slate-300">JSONで問題を送信し、API経由で保存・一覧表示を確認できます。</p>
        </div>
        <a class="inline-flex items-center gap-2 self-start rounded-xl border border-slate-800/80 bg-slate-900/80 px-4 py-2 text-sm font-semibold text-slate-100 shadow hover:border-slate-700 hover:bg-slate-800/80"
           href="/study/requirements.html" target="_blank" rel="noreferrer">仕様メモを見る</a>
      </div>

      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/70 p-5 shadow">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Payload</p>
              <h2 class="text-lg font-semibold">送信するJSON</h2>
            </div>
            <span class="rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-300 border border-emerald-500/40">POST /index.php?r=/questions</span>
          </div>
          <textarea id="json" class="w-full min-h-[320px] rounded-xl border border-slate-800/80 bg-slate-950/70 px-4 py-3 font-mono text-sm leading-relaxed text-slate-100 shadow-inner outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30" spellcheck="false"></textarea>
          <div class="flex items-center justify-end gap-3">
            <button id="submit" class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-emerald-400 via-cyan-300 to-sky-400 px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-500/25 transition hover:translate-y-[1px] hover:shadow-emerald-500/35">
              DBに保存する
            </button>
          </div>
          <div id="status" class="min-h-[1.5rem] text-sm font-mono leading-relaxed text-slate-300"></div>
        </div>

        <div class="space-y-3 rounded-2xl border border-slate-800/70 bg-slate-900/70 p-5 shadow">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">List</p>
              <h2 class="text-lg font-semibold">登録済みの問題</h2>
            </div>
            <span class="rounded-full border border-slate-800/80 bg-slate-950/60 px-3 py-1 text-xs font-semibold text-slate-200">GET /index.php?r=/questions</span>
          </div>
          <div id="list" class="space-y-3 text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const textarea = document.getElementById('json');
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const endpoint = '/index.php?r=/questions';
    const baseStatus = 'min-h-[1.5rem] text-sm font-mono leading-relaxed';

    const sample = [
      {
        "question_id": 1,
        "domain_name": "ネットワーク基礎",
        "topic_name": "OSI参照モデル",
        "title": "トランスポート層の役割",
        "stem": "TCP/IPモデルにおけるトランスポート層の主な役割はどれか。",
        "choices": [
          { "choice_id": 1, "choice_label": "A", "choice_text": "エンド間の信頼性と分割・再構成を担う" },
          { "choice_id": 2, "choice_label": "B", "choice_text": "物理媒体上でのビット伝送を担う" },
          { "choice_id": 3, "choice_label": "C", "choice_text": "アプリケーションのUI提供を担う" },
          { "choice_id": 4, "choice_label": "D", "choice_text": "ルーティングと経路選択を担う" }
        ]
      }
    ];
    textarea.value = JSON.stringify(sample, null, 2);

    function escapeHTML(str) {
      return (str || '').toString().replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[s]);
    }

    async function postData() {
      statusEl.textContent = '送信中...';
      statusEl.className = `${baseStatus} text-slate-300`;
      let payload;
      try {
        payload = JSON.parse(textarea.value);
      } catch (e) {
        statusEl.textContent = 'JSONの構文エラー: ' + e.message;
        statusEl.className = `${baseStatus} text-rose-400`;
        return;
      }
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const body = await res.json();
        if (!res.ok || body.ok === false) {
          throw new Error(JSON.stringify(body));
        }
        statusEl.textContent = '保存成功: ' + JSON.stringify(body);
        statusEl.className = `${baseStatus} text-emerald-400`;
        await loadList();
      } catch (e) {
        statusEl.textContent = 'エラー: ' + e.message;
        statusEl.className = `${baseStatus} text-rose-400`;
      }
    }

    async function loadList() {
      listEl.innerHTML = '<div class="text-slate-400">読込中...</div>';
      try {
        const res = await fetch(endpoint);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('Unexpected response');
        if (data.length === 0) {
          listEl.innerHTML = '<div class="text-slate-400">まだ登録がありません。</div>';
          return;
        }
        listEl.innerHTML = '';
        data.forEach(q => {
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-slate-800/70 bg-slate-950/60 p-4 shadow-md space-y-2';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-400">#${escapeHTML(q.question_id)}</p>
                <h3 class="text-lg font-semibold text-slate-50">${escapeHTML(q.title || '無題')}</h3>
              </div>
              <span class="rounded-lg bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold text-emerald-300 border border-emerald-500/30">Question</span>
            </div>
            <div class="text-sm text-slate-300">${escapeHTML(q.domain_name || '')}${q.topic_name ? ' / ' + escapeHTML(q.topic_name) : ''}</div>
            <p class="text-sm leading-relaxed text-slate-200">${escapeHTML(q.stem || '')}</p>
            <ul class="mt-2 space-y-1 text-sm text-slate-200">
              ${(q.choices || []).map(c => `
                <li class="flex gap-2">
                  <span class="min-w-[1.5rem] font-semibold text-slate-100">${escapeHTML(c.choice_label || '')}.</span>
                  <span class="text-slate-200">${escapeHTML(c.choice_text || '')}</span>
                </li>
              `).join('')}
            </ul>
          `;
          listEl.appendChild(card);
        });
      } catch (e) {
        listEl.innerHTML = '<div class="text-sm font-mono text-rose-400">読み込みエラー: ' + escapeHTML(e.message) + '</div>';
      }
    }

    document.getElementById('submit').addEventListener('click', postData);
    loadList();
  </script>
</body>
</html>
