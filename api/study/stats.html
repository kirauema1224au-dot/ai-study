<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æˆç¸¾åˆ†æ | STUDY LAUNCHER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800;900&display=swap"
    rel="stylesheet">
  <style type="text/tailwindcss">
    :root {
      --primary: #6366f1;
      --secondary: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #fef9c3 0%, #d8b4fe 50%, #818cf8 100%);
    }

    body {
      @apply min-h-screen flex items-center justify-center p-4 md:p-6 text-slate-800 overflow-x-hidden;
      font-family: "M PLUS Rounded 1c", sans-serif;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Shell Components */
    .glass-container {
      @apply w-full max-w-[1100px] flex flex-col overflow-hidden rounded-[3rem] border border-white/40 bg-white/60 shadow-2xl;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
      min-height: 80vh;
    }

    .nav-link {
      @apply relative px-4 py-2 font-black text-slate-500 transition-all hover:text-indigo-600;
    }

    .nav-link.active {
      @apply text-indigo-600;
    }

    .nav-link.active::after {
      content: '';
      @apply absolute bottom-[-5px] left-1/2 h-1 w-6 -translate-x-1/2 rounded-full bg-indigo-600;
    }

    /* Stats Components */
    .stat-progress-bg {
      @apply h-3.5 overflow-hidden rounded-full bg-slate-100;
    }

    .stat-progress-fill {
      @apply h-full rounded-full transition-all duration-1000 ease-out;
    }
    
    @keyframes pageIn {
        from { opacity: 0; transform: translateY(20px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
  </style>
</head>

<body>

  <div class="glass-container">
    <!-- Navigation Bar -->
    <nav class="flex items-center justify-between border-b border-white/20 bg-white/30 px-6 py-4 md:px-8 md:py-6">
      <div class="flex items-center gap-3">
        <div
          class="flex h-11 w-11 rotate-3 items-center justify-center rounded-2xl bg-indigo-600 text-2xl text-white shadow-lg">
          ğŸš€
        </div>
        <h1 class="hidden text-2xl font-black tracking-tighter text-slate-800 md:block">STUDY LAUNCHER</h1>
        <h1 class="block text-xl font-black tracking-tighter text-slate-800 md:hidden">STUDY</h1>
      </div>

      <div class="hidden items-center gap-4 md:flex">
        <a href="/study/index.html" class="nav-link">ãƒ›ãƒ¼ãƒ </a>
        <a href="/study/requirements.html" class="nav-link">AIç”Ÿæˆ</a>
        <a href="/study/stats.html" class="nav-link active">æˆç¸¾åˆ†æ</a>
        <a href="/study/review.html" class="nav-link">å¼±ç‚¹å…‹æœ</a>
      </div>

      <div class="flex items-center gap-4">
        <!-- Logged In State -->
        <div id="user-box" class="hidden items-center gap-4">
          <div class="hidden text-right sm:block">
            <p class="text-[10px] font-black uppercase leading-none text-slate-400">Welcome</p>
            <p id="user-name" class="mt-1 text-xs font-bold leading-none text-slate-600">User</p>
          </div>
          <button id="user-avatar-btn"
            class="relative group h-10 w-10 rounded-full border-2 border-white bg-indigo-50 shadow-sm cursor-pointer overflow-hidden hover:ring-2 hover:ring-indigo-400 transition">
            <img id="user-avatar-img" src="" alt="avatar" class="h-full w-full object-cover">
            <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                </path>
              </svg>
            </div>
          </button>
          <button id="logout-btn" class="text-xs font-bold text-slate-400 hover:text-rose-500">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <!-- Logged Out State -->
        <button id="login-btn"
          class="rounded-xl bg-indigo-600 px-4 py-2 text-xs font-black text-white shadow transition hover:bg-indigo-700">
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </div>
    </nav>

    <!-- Content Area -->
    <main class="flex-grow p-4 md:p-8">
      <div id="p-stats" class="active block animate-[pageIn_0.5s_ease-out]">
        <div class="mb-10 flex flex-wrap items-center justify-between gap-4">
          <div>
            <h2 class="text-3xl font-black tracking-tight text-slate-800">æˆç¸¾åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <p class="text-sm font-medium text-slate-500">ç¾åœ¨ã®ã‚¹ã‚­ãƒ«ãƒãƒ©ãƒ³ã‚¹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
          </div>
          <button id="refresh"
            class="hidden rounded-full border border-slate-200 bg-white px-5 py-2 text-xs font-black text-slate-600 shadow-sm transition hover:bg-slate-50">
            ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          </button>
        </div>

        <div id="status" class="mt-4 text-sm font-bold text-slate-500">èª­ã¿è¾¼ã¿ä¸­...</div>

        <section id="dashboard" class="hidden space-y-10">
          <!-- Main Score Card -->
          <div id="overall-card"
            class="relative mb-10 overflow-hidden rounded-[3rem] bg-indigo-600 p-8 text-white shadow-2xl shadow-indigo-200 md:p-12">
            <!-- JS will inject content here -->
          </div>

          <!-- Category Breakdown -->
          <div id="genre-list" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- JS will inject content here -->
          </div>
        </section>
      </div>
    </main>

    <!-- Footer Status Bar -->
    <footer class="flex items-center justify-between border-t border-white/20 bg-white/20 px-6 py-4 md:px-8">
      <div class="flex gap-4">
        <span class="text-[10px] font-black uppercase tracking-widest text-indigo-500">System Status: Optimal</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="h-2 w-2 animate-pulse rounded-full bg-emerald-500"></span>
        <span class="text-[10px] font-black uppercase text-slate-400">AI Connected</span>
      </div>
    </footer>
  </div>

  <!-- Auth Modal (Identical to index.html) -->
  <div id="auth-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/45 backdrop-blur-sm"></div>
    <div class="absolute left-1/2 top-1/2 w-full max-w-md -translate-x-1/2 -translate-y-1/2 p-4">
      <div class="rounded-[2rem] bg-white p-8 shadow-2xl">
        <h2 class="text-2xl font-black text-slate-800">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</h2>
        <p class="mt-2 text-xs font-bold text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æˆç¸¾ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
        <form id="auth-form" class="mt-6 space-y-4">
          <input id="auth-user" type="text" required placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
            class="w-full rounded-xl border-2 border-slate-100 bg-slate-50 px-4 py-3 font-bold text-slate-700 outline-none transition focus:border-indigo-400 focus:bg-white">
          <input id="auth-pass" type="password" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
            class="w-full rounded-xl border-2 border-slate-100 bg-slate-50 px-4 py-3 font-bold text-slate-700 outline-none transition focus:border-indigo-400 focus:bg-white">
          <div class="flex gap-3 pt-2">
            <button type="submit" name="action" value="login"
              class="flex-1 rounded-xl bg-indigo-600 py-3 text-sm font-black text-white transition hover:bg-indigo-700 hover:shadow-lg">
              ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button type="submit" name="action" value="register"
              class="flex-1 rounded-xl bg-slate-100 py-3 text-sm font-black text-slate-600 transition hover:bg-slate-200">
              æ–°è¦ç™»éŒ²
            </button>
          </div>
        </form>
        <div id="auth-msg" class="mt-4 min-h-[1.25rem] text-center text-xs font-bold text-rose-500"></div>
        <button id="close-auth"
          class="mt-2 w-full rounded-lg border border-slate-200 py-2 text-xs font-black text-slate-400 hover:bg-slate-50">
          é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>

  <!-- Avatar Modal -->
  <div id="avatar-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" id="close-avatar-overlay"></div>
    <div class="absolute left-1/2 top-1/2 w-full max-w-sm -translate-x-1/2 -translate-y-1/2 p-4">
      <div class="rounded-[2.5rem] bg-white p-8 shadow-2xl text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-indigo-50 to-white -z-10"></div>
        <button id="close-avatar"
          class="absolute top-6 right-6 p-2 rounded-full hover:bg-slate-100 transition text-slate-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <h3 class="text-xl font-black text-slate-800 mb-2">ã‚¢ãƒã‚¿ãƒ¼ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
        <p class="text-xs font-bold text-slate-400 mb-8">è‡ªåˆ†ã ã‘ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®šã—ã‚ˆã†</p>

        <div class="relative w-40 h-40 mx-auto mb-8 group">
          <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 group-hover:opacity-30 transition"></div>
          <img id="avatar-preview" src="" alt="Avatar Preview"
            class="w-full h-full rounded-full border-4 border-white shadow-xl bg-white object-cover relative z-10">
          <button id="random-avatar"
            class="absolute bottom-2 right-2 bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 hover:scale-110 transition z-20"
            title="ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
          </button>
        </div>

        <div class="space-y-3">
          <button id="save-avatar"
            class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black text-sm hover:bg-slate-800 hover:shadow-lg hover:-translate-y-0.5 transition flex items-center justify-center gap-2">
            ä¿å­˜ã—ã¦é–‰ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const dashboardEl = document.getElementById('dashboard');
    const overallEl = document.getElementById('overall-card');
    const genreListEl = document.getElementById('genre-list');
    const userNameEl = document.getElementById('user-name');
    const userBox = document.getElementById('user-box');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const refreshBtn = document.getElementById('refresh');
    const authModal = document.getElementById('auth-modal');
    const closeAuthBtn = document.getElementById('close-auth');
    const authForm = document.getElementById('auth-form');
    const authMsgEl = document.getElementById('auth-msg');

    // Avatar Elements
    const avatarBtn = document.getElementById('user-avatar-btn');
    const avatarImg = document.getElementById('user-avatar-img');
    const avatarModal = document.getElementById('avatar-modal');
    const closeAvatarBtn = document.getElementById('close-avatar');
    const closeAvatarOverlay = document.getElementById('close-avatar-overlay');
    const avatarPreview = document.getElementById('avatar-preview');
    const randomAvatarBtn = document.getElementById('random-avatar');
    const saveAvatarBtn = document.getElementById('save-avatar');

    let currentUser = null;
    let tempSeed = '';

    const getAvatarUrl = (seed) => `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e0e7ff`;

    const setStatus = (text, cls = 'text-slate-500') => {
      statusEl.textContent = text;
      statusEl.className = `mt-4 text-sm font-bold ${cls}`;
    };

    const openAuthModal = () => authModal.classList.remove('hidden');
    const closeAuthModal = () => {
      authModal.classList.add('hidden');
      authMsgEl.textContent = '';
    };

    const updateHeader = () => {
      if (currentUser) {
        userNameEl.textContent = currentUser.name;
        // Use notonist style for avatar
        const seed = currentUser.avatar_seed || currentUser.name;
        document.getElementById('user-avatar-img').src = getAvatarUrl(seed);

        userBox.classList.remove('hidden');
        userBox.classList.add('flex');
        loginBtn.classList.add('hidden');
        refreshBtn.classList.remove('hidden');
      } else {
        userBox.classList.add('hidden');
        userBox.classList.remove('flex');
        loginBtn.classList.remove('hidden');
        refreshBtn.classList.add('hidden');
      }
    };

    const renderStats = (data) => {
      const overall = data.overall || {};
      const acc = overall.accuracy ?? '--';
      const correct = overall.correct ?? 0;
      const total = overall.total ?? 0;

      overallEl.innerHTML = `
        <div class="relative z-10 flex flex-col md:flex-row items-center gap-8">
            <div class="flex-shrink-0 w-32 h-32 bg-white/20 rounded-[2.5rem] flex items-center justify-center text-4xl font-black border-4 border-white/30 backdrop-blur-md">
                ${acc}<span class="text-xl ml-1">%</span>
            </div>
            <div class="flex-grow text-center md:text-left">
                <p class="text-indigo-200 text-xs font-black uppercase tracking-widest mb-1">Overall Accuracy</p>
                <h3 class="text-2xl font-black mb-4">ç·åˆæ­£ç­”ç‡</h3>
                <div class="stat-progress-bg bg-white/20">
                    <div class="stat-progress-fill bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)]"
                        style="width: ${Math.max(0, Math.min(100, acc))}%"></div>
                </div>
                <div class="flex justify-between mt-3 text-xs font-bold text-indigo-100 px-1">
                    <span>ç¾åœ¨ã®æ­£è§£æ•°: ${correct}å•</span>
                    <span>åˆè¨ˆå›ç­”æ•°: ${total}å•</span>
                </div>
            </div>
        </div>
        <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
      `;

      const genres = (data.genres || []).slice().sort((a, b) => (a.accuracy ?? 101) - (b.accuracy ?? 101));

      if (genres.length === 0) {
        genreListEl.innerHTML = '<div class="col-span-full rounded-[2rem] border border-slate-200 bg-white/40 p-8 text-center text-sm font-bold text-slate-500">åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’è§£ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼</div>';
        return;
      }

      genreListEl.innerHTML = genres.map((g) => {
        const accVal = g.accuracy ?? 0;
        const width = Math.max(0, Math.min(100, accVal));
        const colorClass = accVal < 40 ? 'bg-rose-400' : accVal < 70 ? 'bg-amber-400' : 'bg-emerald-400';
        const badgeColor = accVal < 40 ? 'bg-rose-100 text-rose-500' : accVal < 70 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600';
        const badgeText = accVal < 40 ? 'è¦å¾©ç¿’' : accVal < 70 ? 'æ¨™æº–' : 'å®‰å®š';
        const name = (g.name || 'æœªåˆ†é¡').toString();

        return `
          <button type="button" data-domain="${encodeURIComponent(name)}"
            class="group bg-white/40 p-6 rounded-[2rem] border border-white/50 text-left transition-all hover:-translate-y-1 hover:bg-white/60 hover:shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm font-black text-slate-700">${name}</span>
                <span class="px-3 py-1 ${badgeColor} rounded-lg text-[10px] font-black">${badgeText}</span>
            </div>
            <div class="text-2xl font-black text-slate-800 mb-2">${accVal}%</div>
            <div class="stat-progress-bg">
                <div class="stat-progress-fill ${colorClass}" style="width: ${width}%"></div>
            </div>
            <p class="text-[10px] text-slate-400 mt-3 font-bold group-hover:text-indigo-500 transition-colors">${g.correct} / ${g.total} æ­£è§£ - ã‚¯ãƒªãƒƒã‚¯ã§å¾©ç¿’</p>
          </button>
        `;
      }).join('');

      genreListEl.querySelectorAll('[data-domain]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const encoded = btn.getAttribute('data-domain') || '';
          const domain = decodeURIComponent(encoded);
          const q = domain ? `?domain=${encodeURIComponent(domain)}` : '';
          window.location.href = `/study/review.html${q}`;
        });
      });
    };

    const loadStats = async () => {
      if (!currentUser) {
        dashboardEl.classList.add('hidden');
        setStatus('ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æˆç¸¾åˆ†æã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚');
        return;
      }
      setStatus('æˆç¸¾ã‚’å–å¾—ä¸­...');
      try {
        const res = await fetch('/index.php?r=/stats');
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || 'stats failed');
        }
        renderStats(data);
        dashboardEl.classList.remove('hidden');
        setStatus(''); // Clear fetching message on success
        statusEl.classList.add('hidden');
      } catch (e) {
        dashboardEl.classList.add('hidden');
        setStatus(`å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, 'text-rose-500');
        statusEl.classList.remove('hidden');
      }
    };

    const checkSession = async () => {
      try {
        const res = await fetch('/index.php?r=/me');
        const data = await res.json();
        currentUser = data?.logged_in ? data.user : null;
      } catch (_) {
        currentUser = null;
      }
      updateHeader();
      await loadStats();
    };

    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const action = e.submitter?.value || 'login';
      const endpoint = action === 'register' ? '/index.php?r=/register' : '/index.php?r=/login';
      const username = document.getElementById('auth-user').value.trim();
      const password = document.getElementById('auth-pass').value;

      try {
        authMsgEl.textContent = 'é€ä¿¡ä¸­...';
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        if (action === 'register') {
          const loginRes = await fetch('/index.php?r=/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const loginData = await loginRes.json();
          if (!loginRes.ok || loginData.ok === false) {
            throw new Error(loginData.error || 'å†ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          currentUser = loginData.user;
        } else {
          currentUser = data.user;
        }

        closeAuthModal();
        updateHeader();
        await loadStats(); // Reload stats after login
      } catch (err) {
        authMsgEl.textContent = err.message;
      }
    });

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
        await fetch('/index.php?r=/logout');
        currentUser = null;
        updateHeader();
        loadStats(); // Reload (clear) stats
      });
    }

    loginBtn.addEventListener('click', openAuthModal);
    closeAuthBtn.addEventListener('click', closeAuthModal);
    refreshBtn.addEventListener('click', loadStats);

    // --- Avatar Logic ---
    const openAvatarModal = () => {
      if (!currentUser) return;
      tempSeed = currentUser.avatar_seed || currentUser.name;
      avatarPreview.src = getAvatarUrl(tempSeed);
      avatarModal.classList.remove('hidden');
    };

    const closeAvatarModalState = () => {
      avatarModal.classList.add('hidden');
    };

    const generateRandomAvatar = () => {
      tempSeed = Math.random().toString(36).substring(7);
      avatarPreview.src = getAvatarUrl(tempSeed);
    };

    const saveAvatar = async () => {
      if (!currentUser) return;
      const oldSeed = currentUser.avatar_seed;

      // Optimistic update
      currentUser.avatar_seed = tempSeed;
      if (avatarImg) avatarImg.src = getAvatarUrl(tempSeed);
      closeAvatarModalState();

      try {
        const res = await fetch('/index.php?r=/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatar_seed: tempSeed })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
      } catch (err) {
        console.error('Failed to save avatar:', err);
        // Revert
        currentUser.avatar_seed = oldSeed;
        if (avatarImg) avatarImg.src = getAvatarUrl(oldSeed || currentUser.name);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    if (avatarBtn) avatarBtn.addEventListener('click', openAvatarModal);
    if (closeAvatarBtn) closeAvatarBtn.addEventListener('click', closeAvatarModalState);
    if (closeAvatarOverlay) closeAvatarOverlay.addEventListener('click', closeAvatarModalState);
    if (randomAvatarBtn) randomAvatarBtn.addEventListener('click', generateRandomAvatar);
    if (saveAvatarBtn) saveAvatarBtn.addEventListener('click', saveAvatar);

    checkSession();
  </script>
</body>

</html>